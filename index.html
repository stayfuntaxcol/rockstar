
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini CRM – Leads</title>
  <style>
      const firebaseConfig = {
    apiKey: "AIzaSyDWjt0YeuEhUCMMOKToGUhjq21K8HlZ8Fk",
    authDomain: "rock-f5937.firebaseapp.com",
    projectId: "rock-f5937",
    storageBucket: "rock-f5937.firebasestorage.app",
    messagingSenderId: "1066836195707",
    appId: "1:1066836195707:web:153c8721f8cf0510af65de",
    measurementId: "G-SLZXLRZMCG"
  };
    :root{ --bg:#f6f7fb; --card:#fff; --ink:#111; --muted:#666; --line:#e5e7eb; --brand:#0ea5a3; --danger:#ef4444; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--ink)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0}
    h1{font-size:18px;margin:0}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    .row{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    input,select,textarea,button{font:inherit;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    button{background:var(--brand);color:#fff;border:none;cursor:pointer}
    button.secondary{background:#fff;color:var(--ink);border:1px solid var(--line)}
    button.danger{background:var(--danger)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
    th{font-weight:600;background:#fafafa;position:sticky;top:54px}
    .right{margin-left:auto}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .grid label{font-size:12px;color:var(--muted)}
    .grid input,.grid select,.grid textarea{width:100%}
    .grid textarea{grid-column:span 6;min-height:80px;resize:vertical}
    .actions{display:flex;gap:6px}
  </style>
</head>
<body>
  <header>
    <h1>Mini CRM – Leads</h1>
    <div class="row">
      <input id="search" placeholder="Zoek (naam, email, bedrijf, notities)..." />
      <select id="stageFilter">
        <option value="">Alle fases</option>
        <option>Nieuw</option>
        <option>Contact</option>
        <option>Kwalificatie</option>
        <option>Offerte</option>
        <option>Winst</option>
        <option>Verloren</option>
      </select>
      <button id="btnRefresh" class="secondary">Verversen</button>
    </div>
    <button id="btnNew">+ Nieuwe lead</button>
  </header>

  <main>
    <section class="card" id="formCard" style="display:none">
      <h3 id="formTitle" class="muted">Nieuwe lead</h3>
      <div class="grid">
        <div>
          <label>Naam *</label>
          <input id="f_name" required />
        </div>
        <div>
          <label>Bedrijf</label>
          <input id="f_company" />
        </div>
        <div>
          <label>Email</label>
          <input id="f_email" type="email" />
        </div>
        <div>
          <label>Telefoon</label>
          <input id="f_phone" />
        </div>
        <div>
          <label>Fase</label>
          <select id="f_stage">
            <option>Nieuw</option>
            <option>Contact</option>
            <option>Kwalificatie</option>
            <option>Offerte</option>
            <option>Winst</option>
            <option>Verloren</option>
          </select>
        </div>
        <div class="right muted" style="align-self:end">Velden met * zijn verplicht</div>
        <textarea id="f_notes" placeholder="Notities"></textarea>
      </div>
      <div class="actions" style="margin-top:8px">
        <button id="btnSave">Opslaan</button>
        <button id="btnCancel" class="secondary">Annuleren</button>
      </div>
      <input type="hidden" id="f_id" />
    </section>

    <section class="card">
      <table id="leadTable">
        <thead>
          <tr>
            <th style="width:110px">Aangemaakt</th>
            <th>Naam</th>
            <th>Bedrijf</th>
            <th>Email</th>
            <th>Telefoon</th>
            <th style="width:120px">Fase</th>
            <th>Notities</th>
            <th style="width:140px">Acties</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="emptyState" class="muted" style="display:none;padding:12px">Nog geen leads gevonden.</div>
    </section>
  </main>

<script>
const API = 'api.php';

const $ = (sel) => document.querySelector(sel);
const tbody = document.querySelector('#leadTable tbody');

function fmtDate(dstr){
  const d = new Date(dstr);
  if (isNaN(d.getTime())) return '';
  return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
}

async function listLeads(){
  const q = encodeURIComponent($('#search').value.trim());
  const stage = encodeURIComponent($('#stageFilter').value);
  const url = `${API}?search=${q}&stage=${stage}`;
  const res = await fetch(url);
  const data = await res.json();
  renderTable(data);
}

function renderTable(rows){
  tbody.innerHTML = '';
  if (!rows.length){ $('#emptyState').style.display='block'; return; }
  $('#emptyState').style.display='none';
  for (const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtDate(r.created_at)}</td>
      <td><strong>${escapeHtml(r.name||'')}</strong></td>
      <td>${escapeHtml(r.company||'')}</td>
      <td>${escapeHtml(r.email||'')}</td>
      <td>${escapeHtml(r.phone||'')}</td>
      <td>${escapeHtml(r.stage||'')}</td>
      <td>${escapeHtml(r.notes||'')}</td>
      <td class="actions">
        <button onclick='editLead(${r.id})' class="secondary">Bewerk</button>
        <button onclick='removeLead(${r.id})' class="danger">Verwijder</button>
      </td>`;
    tbody.appendChild(tr);
  }
}

function escapeHtml(s){
  return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function showForm(edit=false){
  $('#formCard').style.display='block';
  $('#formTitle').textContent = edit ? 'Lead bewerken' : 'Nieuwe lead';
}
function hideForm(){ $('#formCard').style.display='none'; clearForm(); }
function clearForm(){
  $('#f_id').value='';
  $('#f_name').value='';
  $('#f_company').value='';
  $('#f_email').value='';
  $('#f_phone').value='';
  $('#f_stage').value='Nieuw';
  $('#f_notes').value='';
}

async function saveLead(){
  const id = $('#f_id').value;
  const payload = {
    name: $('#f_name').value.trim(),
    company: $('#f_company').value.trim(),
    email: $('#f_email').value.trim(),
    phone: $('#f_phone').value.trim(),
    stage: $('#f_stage').value,
    notes: $('#f_notes').value.trim(),
  };
  if (!payload.name){ alert('Naam is verplicht'); return; }

  let res;
  if (!id){
    res = await fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  } else {
    res = await fetch(`${API}?id=${encodeURIComponent(id)}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  }
  const data = await res.json();
  if (!res.ok){ alert(data.error || 'Onbekende fout'); return; }
  hideForm();
  listLeads();
}

async function editLead(id){
  // Fetch single by GET and filter client-side; or list and find.
  const res = await fetch(API);
  const all = await res.json();
  const r = all.find(x => x.id == id);
  if (!r){ alert('Lead niet gevonden'); return; }
  $('#f_id').value = r.id;
  $('#f_name').value = r.name || '';
  $('#f_company').value = r.company || '';
  $('#f_email').value = r.email || '';
  $('#f_phone').value = r.phone || '';
  $('#f_stage').value = r.stage || 'Nieuw';
  $('#f_notes').value = r.notes || '';
  showForm(true);
}

async function removeLead(id){
  if (!confirm('Verwijderen? Dit kan niet ongedaan worden gemaakt.')) return;
  const res = await fetch(`${API}?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
  const data = await res.json();
  if (!res.ok){ alert(data.error || 'Verwijderen mislukt'); return; }
  listLeads();
}

$('#btnNew').addEventListener('click', () => { clearForm(); showForm(false); });
$('#btnCancel').addEventListener('click', hideForm);
$('#btnSave').addEventListener('click', saveLead);
$('#btnRefresh').addEventListener('click', listLeads);
$('#search').addEventListener('input', () => { listLeads(); });
$('#stageFilter').addEventListener('change', listLeads);

listLeads();
</script>
</body>
</html>
